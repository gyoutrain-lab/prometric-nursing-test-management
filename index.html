<!-- ======= ADMIN CODE GENERATOR + VERIFY (paste before </body>) ======= -->
<script>
/*
  Admin & user unlock flow (client-side friendly).
  - Admin opens Admin Panel (PIN) -> generates code -> sends code via WhatsApp to user.
  - If you have a backend endpoint (e.g. /register-code), the script will POST the new code
    to that endpoint (set backendUrl). If empty, it will not POST.
  - The user can unlock by entering their WA number + code. The front-end verifies either
    against live codes fetched from backend (if backendUrl set) OR a client-side store (validCodes).
*/

const backendUrl = ""; // <-- OPTIONAL: set to your deployed backend URL (e.g. "https://your-railway-app.up.railway.app")
                        // If left empty, script runs in manual mode (no central persistence).

/* -------------------------
   Simple UI injection
   ------------------------- */
(function injectAdminUI(){
  const adminHtml = `
    <div id="admin-panel" style="position:fixed;right:12px;bottom:12px;z-index:9999;font-family:Arial,sans-serif;">
      <button id="admin-open-btn" style="background:#222;color:#fff;padding:8px 12px;border-radius:8px;border:none;box-shadow:0 2px 6px rgba(0,0,0,.2);">Admin</button>
      <div id="admin-modal" style="display:none;width:320px;padding:14px;border-radius:12px;background:#fff;box-shadow:0 8px 30px rgba(0,0,0,.2);margin-top:8px">
        <div style="text-align:right"><button id="admin-close" style="border:none;background:transparent;font-weight:bold;cursor:pointer">✕</button></div>
        <h3 style="margin:6px 0 12px 0">Admin — Generate Unlock</h3>
        <label style="font-size:.9rem;color:#333">Admin PIN</label>
        <input id="admin-pin-input" type="password" placeholder="enter PIN" style="width:100%;padding:8px;margin:6px 0 10px;border-radius:6px;border:1px solid #ddd">
        <div id="admin-panel-body" style="display:none">
          <label style="font-size:.9rem;color:#333">User WhatsApp (with +62...)</label>
          <input id="admin-wa" placeholder="+628xxxxxxxxxx" style="width:100%;padding:8px;margin:6px 0 10px;border-radius:6px;border:1px solid #ddd">
          <label style="font-size:.9rem;color:#333">Select Module</label>
          <select id="admin-module" style="width:100%;padding:8px;margin:6px 0 10px;border-radius:6px;border:1px solid #ddd">
            <option value="pharmacology">Pharmacology</option>
            <option value="fundamental">Fundamental Nursing</option>
            <option value="behavioral">Behavioral / Ethics</option>
            <option value="criticalcare">Critical Care</option>
            <option value="maternity">Maternity & Obstetric</option>
            <option value="medicalsurgical">Medical-Surgical</option>
          </select>

          <div style="display:flex;gap:8px;margin-bottom:8px">
            <button id="generate-code-btn" style="flex:1;padding:10px;border-radius:8px;border:none;background:#4a90e2;color:white;cursor:pointer">Generate Code</button>
            <button id="export-codes-btn" title="Download codes.json" style="padding:10px;border-radius:8px;border:1px solid #ddd;background:white;cursor:pointer">Export</button>
          </div>

          <div style="font-size:.9rem;color:#333;margin-bottom:8px">
            <div><strong>Last code:</strong></div>
            <div id="last-code" style="padding:8px;border-radius:6px;background:#f8f8f8;border:1px dashed #ddd;margin-top:6px">—</div>
          </div>

          <div style="display:flex;gap:8px">
            <button id="copy-code-btn" style="flex:1;padding:10px;border-radius:8px;border:none;background:#2ecc71;color:white;cursor:pointer">Copy code</button>
            <button id="send-wa-btn" style="flex:2;padding:10px;border-radius:8px;border:none;background:#25D366;color:white;cursor:pointer">Open WhatsApp (send)</button>
          </div>

          <hr style="margin:12px 0">
          <div style="font-size:.85rem;color:#555">
            <div><strong>Notes</strong></div>
            <div style="margin-top:6px">After payment confirmation in OVO, generate code and send to the buyer. If you have backend, the code will be posted to the backend for verification by users.</div>
          </div>
        </div>
      </div>
    </div>
  `;
  const wrapper = document.createElement('div');
  wrapper.innerHTML = adminHtml;
  document.body.appendChild(wrapper);

  // Wire buttons
  document.getElementById('admin-open-btn').addEventListener('click', ()=> {
    document.getElementById('admin-modal').style.display='block';
    // show PIN prompt inline
  });
  document.getElementById('admin-close').addEventListener('click', ()=> {
    document.getElementById('admin-modal').style.display='none';
  });
})();

/* -------------------------
   Simple PIN check + admin auth
   ------------------------- */
const ADMIN_PIN = "5821"; // change this to your secret PIN (use a strong number). Admin enters this to reveal panel.

document.getElementById('admin-pin-input').addEventListener('keydown', (e)=>{
  if(e.key === 'Enter') tryAdminPin();
});
document.getElementById('admin-pin-input').addEventListener('blur', ()=>{}); // noop

function tryAdminPin(){
  const v = document.getElementById('admin-pin-input').value.trim();
  if(v === ADMIN_PIN){
    document.getElementById('admin-panel-body').style.display='block';
    document.getElementById('admin-pin-input').value = "";
  } else {
    alert("Incorrect PIN.");
  }
}

/* -------------------------
   Local codes store (client-side)
   Structure: codesStore = [{ code, phone, module, createdAt, used:false }]
   ------------------------- */
const CODES_KEY = "prometric_codes_store_v1";

function loadCodesStore(){
  try{
    return JSON.parse(localStorage.getItem(CODES_KEY) || "[]");
  }catch(e){ return []; }
}
function saveCodesStore(arr){
  localStorage.setItem(CODES_KEY, JSON.stringify(arr));
}

/* -------------------------
   Generate random code
   ------------------------- */
function makeCode(len=8){
  const chars = "ABCDEFGHJKMNPQRSTUVWXYZ23456789"; // avoid ambiguous chars
  let s = "";
  for(let i=0;i<len;i++) s += chars.charAt(Math.floor(Math.random()*chars.length));
  // add module prefix optionally
  return s;
}

/* -------------------------
   Button handlers
   ------------------------- */
document.getElementById('generate-code-btn').addEventListener('click', async ()=>{
  const phone = document.getElementById('admin-wa').value.trim();
  const moduleName = document.getElementById('admin-module').value;
  if(!phone){ alert("Enter user's WhatsApp number (include +62)"); return; }

  const code = makeCode(7);
  const rec = { code, phone, module:moduleName, createdAt: new Date().toISOString(), used:false };
  const store = loadCodesStore();
  store.push(rec);
  saveCodesStore(store);

  // show last code
  document.getElementById('last-code').textContent = `${code}  —  ${phone}  —  ${moduleName}`;

  // If backend is configured, register the code remotely (optional)
  if(backendUrl){
    try{
      const res = await fetch(`${backendUrl}/register`, {
        method:'POST',
        headers:{ 'Content-Type':'application/json' },
        body: JSON.stringify(rec)
      });
      if(res.ok){
        alert("Code generated and registered on backend. You can send it via WhatsApp.");
      } else {
        alert("Code generated locally. Backend registration failed.");
      }
    }catch(err){
      console.warn(err);
      alert("Code generated locally. Backend registration failed (network).");
    }
  } else {
    alert("Code generated locally. Tap Copy or Open WhatsApp to send.");
  }
});

// Copy to clipboard
document.getElementById('copy-code-btn').addEventListener('click', ()=>{
  const last = loadCodesStore().slice(-1)[0];
  if(!last) return alert("No code generated yet.");
  navigator.clipboard.writeText(`${last.code}`).then(()=>alert("Code copied to clipboard"));
});

// Open WhatsApp to send prefilled message
document.getElementById('send-wa-btn').addEventListener('click', ()=>{
  const last = loadCodesStore().slice(-1)[0];
  if(!last) return alert("No code generated yet.");
  const text = encodeURIComponent(`Hello — your unlock code for ${last.module} is: ${last.code}\nPlease enter this code on the test dashboard to open the module.\nThis code is one-time-use and tied to your WhatsApp: ${last.phone}`);
  // open chat with the user's number
  window.open(`https://wa.me/${last.phone.replace(/^\+/, '')}?text=${text}`, "_blank");
});

// Export codes as JSON file
document.getElementById('export-codes-btn').addEventListener('click', ()=>{
  const data = loadCodesStore();
  const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = `unlock-codes-${new Date().toISOString().slice(0,10)}.json`;
  document.body.appendChild(a); a.click(); a.remove();
  URL.revokeObjectURL(url);
});

/* -------------------------
   User-side verification (when user inputs code)
   This part should be integrated with your existing lockModule() logic:
   - If backendUrl is set, fetch live codes from backend to verify.
   - Else verify against a client-side fetched 'validCodes' mapping created by admin.
   ------------------------- */

/*
 Example helper you can call from your lockModule(moduleName, url) flow:

   verifyCodeForUser(userPhone, code, moduleName)
     -> returns { ok:true } or { ok:false, reason: '...' }

*/

async function verifyCodeForUser(userPhone, code, moduleName){
  // 1) Backend mode (if configured)
  if(backendUrl){
    try{
      const res = await fetch(`${backendUrl}/verify`, {
        method:'POST',
        headers:{ 'Content-Type':'application/json' },
        body: JSON.stringify({ phone: userPhone, code, module: moduleName })
      });
      if(!res.ok) return { ok:false, reason:'server' };
      const j = await res.json();
      return j; // expects { ok:true } or { ok:false, reason:'...' }
    }catch(e){
      console.warn(e);
      return { ok:false, reason:'network' };
    }
  }

  // 2) Manual/local mode: check local admin-created store (only works if the admin used the same browser origin to generate codes)
  const store = loadCodesStore();
  const found = store.find(r => r.code === code && r.phone === userPhone && r.module === moduleName && !r.used);
  if(found){
    // mark used
    found.used = true;
    saveCodesStore(store);
    return { ok:true };
  }

  // 3) If no backend and not found
  return { ok:false, reason:'not_found' };
}

/* -------------------------
   Utility to mark a module unlocked for the visitor (use in your lockModule after successful verification)
   ------------------------- */
function markModuleUnlockedForVisitor(moduleName){
  const store = JSON.parse(localStorage.getItem('unlockedModules') || "{}");
  store[moduleName] = true;
  localStorage.setItem('unlockedModules', JSON.stringify(store));
}

/* -------------------------
   Example: integration snippet for your existing lockModule call
   Replace your existing prompt-based verification with this pattern:
   ------------------------- */
/*
async function handleUserUnlockFlow(moduleName, redirectUrl){
  // open WA prompt (optional)
  const waMsg = encodeURIComponent(`Hello, I want to unlock the "${moduleName}" test and will pay via OVO to +6285399652487.`);
  window.open(`https://wa.me/+6285399652487?text=${waMsg}`, '_blank');

  const userPhone = prompt("Enter the WhatsApp number you used (e.g., +628123...):");
  if(!userPhone) return alert("You didn't enter your WhatsApp number.");

  const code = prompt("Enter the unlock code you received via WhatsApp after payment:");
  if(!code) return alert("No code entered.");

  const v = await verifyCodeForUser(userPhone, code, moduleName);
  if(v.ok){
    markModuleUnlockedForVisitor(moduleName);
    alert("Unlocked! Redirecting...");
    window.location.href = redirectUrl;
  } else {
    alert("Invalid code or verification failed: " + (v.reason || "unknown"));
  }
}
*/

</script>
<!-- ======= END ADMIN CODE GENERATOR ======= -->

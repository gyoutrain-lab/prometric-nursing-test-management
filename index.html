<script>
const REPO_OWNER = "gyoutrain-lab";
const REPO_NAME = "prometric-nursing-test-management";
const FILE_PATH = "codes.json";
const PROXY_URL = "https://script.google.com/macros/s/AKfycbxJ9xxxxxx/exec"; // your Apps Script URL

// --- Triggered when user clicks locked module ---
function requestUnlock(moduleName) {
  alert(`This module (${moduleName}) is locked.\nPlease contact via WhatsApp to unlock.`);
  document.getElementById("unlockModal").style.display = "flex";
}

function closeModal(){
  document.getElementById("unlockModal").style.display = "none";
}

// --- Verify unlock code ---
async function verifyCode(){
  const code = document.getElementById("unlockCode").value.trim().toUpperCase();
  if(!code) return alert("Please enter a code.");

  const res = await fetch(`https://raw.githubusercontent.com/${REPO_OWNER}/${REPO_NAME}/main/${FILE_PATH}`);
  const codes = await res.json();

  const match = codes.find(c=>c.code===code && !c.used);
  if(match){
    alert("✅ Code accepted! All modules unlocked.");
    localStorage.setItem("unlocked","true");
    closeModal();
    renderModules(true);

    // --- mark code as used ---
    try {
      await fetch(PROXY_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ code })
      });
      console.log("Code marked as used.");
    } catch(err){
      console.error("Failed to update GitHub:", err);
    }

  } else {
    alert("❌ Invalid or already used code.");
  }
}

function renderModules(unlocked){
  document.querySelectorAll(".module").forEach(m=>{
    if(m.classList.contains("locked")){
      if(unlocked){
        m.classList.remove("locked");
        m.classList.add("active");
        const text = m.textContent.trim();
        if(text==="Pharmacology") m.setAttribute("onclick","window.location.href='https://gyoutrain-lab.github.io/nursing-prometric-test-pharmacology/'");
        if(text==="Behavioral / Ethics") m.setAttribute("onclick","window.location.href='https://gyoutrain-lab.github.io/nursing-prometric-test-eticabehabior/'");
        if(text==="Critical Care") m.setAttribute("onclick","window.location.href='https://gyoutrain-lab.github.io/nursing-prometric-test-criticalcare2/'");
        if(text==="Maternity & Obstetric") m.setAttribute("onclick","window.location.href='https://gyoutrain-lab.github.io/nursing-prometric-test-maternityobstetric/'");
        if(text==="Fundamental Nursing") m.setAttribute("onclick","window.location.href='https://gyoutrain-lab.github.io/nursing-prometric-test/'");
        if(text==="Medical-Surgical") m.setAttribute("onclick","window.location.href='https://gyoutrain-lab.github.io/nursing-prometric-test-medical-surgical/'");
      }
    }
  });
}

// --- Load saved unlock state ---
window.onload = ()=>{
  const unlocked = localStorage.getItem("unlocked")==="true";
  renderModules(unlocked);
}
</script>

<!-- ===== FULL ADMIN + AUTO-EXPIRE-ON-ALL-TESTS SCRIPT ===== -->
<script>
/*
  Auto-expire-after-all-tests script.
  - Admin can generate codes for a phone (+62...) and choose which modules the code unlocks.
  - Code remains valid until the user has "used" (opened/completed) all unlocked modules at least once.
  - When all unlocked modules are used, the code is marked used/expired automatically.
  - Modes:
     - backendUrl = ""  -> Manual/local mode (codes stored in localStorage on THIS origin)
     - backendUrl = "https://your-backend" -> Backend mode (recommended)
*/

const backendUrl = ""; // <-- OPTIONAL: set to your backend if you deploy server endpoints /register and /verify

/* ---------------------------
   Admin UI injection
   --------------------------- */
(function createAdminUI(){
  const html = `
  <div id="admin-ui" style="position:fixed;right:12px;bottom:12px;z-index:9999;font-family:Arial,sans-serif;">
    <button id="admin-btn" style="background:#222;color:#fff;padding:8px 12px;border-radius:8px;border:none;box-shadow:0 2px 6px rgba(0,0,0,.2);">Admin</button>
    <div id="admin-modal" style="display:none;width:340px;padding:14px;border-radius:12px;background:#fff;box-shadow:0 8px 30px rgba(0,0,0,.2);margin-top:8px;color:#222">
      <div style="text-align:right"><button id="admin-close" style="border:none;background:transparent;font-weight:bold;cursor:pointer">✕</button></div>
      <h3 style="margin:6px 0 12px 0">Admin — Generate Unlock</h3>
      <label style="font-size:.9rem;color:#333">Enter Admin PIN</label>
      <input id="admin-pin-input" type="password" placeholder="PIN" style="width:100%;padding:8px;margin:6px 0 10px;border-radius:6px;border:1px solid #ddd">
      <div id="admin-body" style="display:none">
        <label style="font-size:.9rem;color:#333">Buyer WhatsApp (include +)</label>
        <input id="admin-phone" placeholder="+628xxxxxxxxxx" style="width:100%;padding:8px;margin:6px 0 10px;border-radius:6px;border:1px solid #ddd">

        <label style="font-size:.9rem;color:#333">Modules to unlock (checked = included)</label>
        <div style="display:flex;flex-direction:column;gap:6px;margin:8px 0 12px">
          <label><input type="checkbox" class="admin-module" value="pharmacology" checked> Pharmacology</label>
          <label><input type="checkbox" class="admin-module" value="fundamental" checked> Fundamental Nursing</label>
          <label><input type="checkbox" class="admin-module" value="behavioral" checked> Behavioral / Ethics</label>
          <label><input type="checkbox" class="admin-module" value="criticalcare" checked> Critical Care</label>
          <label><input type="checkbox" class="admin-module" value="maternity" checked> Maternity & Obstetric</label>
          <label><input type="checkbox" class="admin-module" value="medicalsurgical" checked> Medical-Surgical</label>
        </div>

        <div style="display:flex;gap:8px;margin-bottom:8px">
          <button id="generate-code" style="flex:1;padding:10px;border-radius:8px;border:none;background:#4a90e2;color:white;cursor:pointer">Generate Code</button>
          <button id="export-codes" title="Download codes.json" style="padding:10px;border-radius:8px;border:1px solid #ddd;background:white;cursor:pointer">Export</button>
        </div>

        <div style="font-size:.9rem;color:#333;margin-bottom:10px">
          <div><strong>Last code (copy & send):</strong></div>
          <div id="last-code" style="padding:8px;border-radius:6px;background:#f8f8f8;border:1px dashed #ddd;margin-top:6px;word-break:break-all">—</div>
        </div>

        <div style="display:flex;gap:8px">
          <button id="copy-last" style="flex:1;padding:10px;border-radius:8px;border:none;background:#2ecc71;color:white;cursor:pointer">Copy code</button>
          <button id="open-wa" style="flex:1;padding:10px;border-radius:8px;border:none;background:#25D366;color:white;cursor:pointer">Open WA to send</button>
        </div>

        <hr style="margin:12px 0">
        <div style="font-size:.85rem;color:#555">
          <div><strong>Notes</strong></div>
          <div style="margin-top:6px">After payment confirmation in OVO, generate code and send to buyer. Code will expire automatically once buyer has used (opened/completed) every module included in this code.</div>
        </div>
      </div>
    </div>
  </div>`;
  const w = document.createElement('div');
  w.innerHTML = html;
  document.body.appendChild(w);

  document.getElementById('admin-btn').addEventListener('click', () => {
    document.getElementById('admin-modal').style.display = 'block';
  });
  document.getElementById('admin-close').addEventListener('click', () => {
    document.getElementById('admin-modal').style.display = 'none';
  });
})();

/* ---------------------------
   Admin PIN
   --------------------------- */
const ADMIN_PIN = "5821"; // change to your PIN
document.getElementById('admin-pin-input').addEventListener('keydown', (e) => {
  if (e.key === 'Enter') tryPin();
});
function tryPin(){
  const v = document.getElementById('admin-pin-input').value.trim();
  if(v === ADMIN_PIN){
    document.getElementById('admin-body').style.display = 'block';
    document.getElementById('admin-pin-input').value = '';
  } else {
    alert('Incorrect PIN');
  }
}

/* ---------------------------
   Local store helpers
   --------------------------- */
const CODES_KEY = 'prometric_codes_v2'; // array of code records
function loadCodes(){
  try { return JSON.parse(localStorage.getItem(CODES_KEY) || "[]"); }
  catch(e){ return []; }
}
function saveCodes(arr){ localStorage.setItem(CODES_KEY, JSON.stringify(arr)); }

/* ---------------------------
   Random code generator
   --------------------------- */
function genCode(n = 8){
  const chars = "ABCDEFGHJKMNPQRSTUVWXYZ23456789";
  let s = "";
  for(let i=0;i<n;i++) s += chars.charAt(Math.floor(Math.random()*chars.length));
  return s;
}

/* ---------------------------
   Admin: generate code handler
   --------------------------- */
document.getElementById('generate-code').addEventListener('click', async () => {
  const phone = document.getElementById('admin-phone').value.trim();
  if(!phone){ alert('Enter buyer WhatsApp (include +)'); return; }

  // collect checked modules
  const checked = Array.from(document.querySelectorAll('.admin-module:checked')).map(i=>i.value);
  if(checked.length === 0){ alert('Select at least one module'); return; }

  // generate record
  const code = genCode(8);
  const record = {
    code,
    phone,
    modules: checked,         // modules unlocked by this code
    createdAt: new Date().toISOString(),
    used: false,
    completed: {}             // track which modules the buyer has completed, keys: moduleName -> true
  };

  // save locally
  const store = loadCodes();
  store.push(record);
  saveCodes(store);

  // show last code
  document.getElementById('last-code').textContent = `${code}  —  ${phone}  —  modules: ${checked.join(', ')}`;

  // optional: register to backend if backendUrl set
  if(backendUrl){
    try{
      const res = await fetch(backendUrl + '/register', {
        method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(record)
      });
      if(res.ok) alert('Code registered to backend. Copy/send via WhatsApp.');
      else alert('Code generated locally; backend registration failed.');
    }catch(e){
      console.warn(e);
      alert('Code generated locally; backend registration failed (network).');
    }
  } else {
    alert('Code generated locally. Copy and send via WhatsApp.');
  }
});

/* ---------------------------
   Admin: copy & send actions
   --------------------------- */
document.getElementById('copy-last').addEventListener('click', () => {
  const store = loadCodes();
  if(store.length === 0) return alert('No codes yet');
  const last = store[store.length-1];
  navigator.clipboard.writeText(last.code).then(()=>alert('Code copied to clipboard'));
});
document.getElementById('open-wa').addEventListener('click', () => {
  const store = loadCodes(); if(store.length === 0) return alert('No codes yet');
  const last = store[store.length-1];
  const text = encodeURIComponent(`Hello — your unlock code for modules (${last.modules.join(', ')}) is: ${last.code}\nPlease enter this code on the test dashboard to unlock the modules. This code expires only after you have used all listed modules at least once.`);
  // open chat to buyer (remove + for wa.me)
  const p = last.phone.replace(/^\+/, '');
  window.open(`https://wa.me/${p}?text=${text}`, '_blank');
});

/* ---------------------------
   Admin: export
   --------------------------- */
document.getElementById('export-codes').addEventListener('click', () => {
  const data = loadCodes();
  const blob = new Blob([JSON.stringify(data, null, 2)], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = `unlock-codes-${new Date().toISOString().slice(0,10)}.json`;
  document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
});

/* ---------------------------
   User-side verification (called by your lockModule flow)
   - If backendUrl is set, it will POST to backend /verify and expect {ok:true}.
   - Else it will check local storage (only works if admin generated code on same site/origin).
   --------------------------- */
async function verifyCodeForUser(userPhone, code) {
  // backend first
  if(backendUrl){
    try{
      const res = await fetch(backendUrl + '/verify', {
        method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({phone:userPhone, code})
      });
      if(!res.ok) return { ok:false, reason:'server' };
      const j = await res.json();
      return j; // expects { ok:true, record: {modules: [...]} } or { ok:false }
    }catch(e){
      console.warn(e);
      return { ok:false, reason:'network' };
    }
  }

  // local mode
  const store = loadCodes();
  const rec = store.find(r => r.code === code && r.phone === userPhone && !r.used);
  if(!rec) return { ok:false, reason:'not_found' };
  // return record and allow unlocking
  return { ok:true, record: rec };
}

/* ---------------------------
   Mark module as completed for the code (this is where auto-expire logic runs)
   - moduleName is string, code is the code string
   - returns { ok:true, expired:bool, remaining:[...], modules:[...] }
   --------------------------- */
function markModuleCompleted(code, moduleName){
  // backend path (not implemented here) would call an endpoint to mark completion centrally
  if(backendUrl){
    // if you implement backend endpoints, call them here.
    // For now return not-implemented
    return { ok:false, reason:'backend-not-implemented' };
  }

  // Local mode:
  const store = loadCodes();
  const rec = store.find(r => r.code === code && !r.used);
  if(!rec) return { ok:false, reason:'not_found' };

  // mark module completed if module in rec.modules
  if(!rec.modules.includes(moduleName)) return { ok:false, reason:'module_not_in_code' };

  rec.completed = rec.completed || {};
  rec.completed[moduleName] = true;

  // check if all modules completed
  const allDone = rec.modules.every(m => rec.completed[m]);
  if(allDone){
    rec.used = true; // expire code
  }

  // save
  saveCodes(store);

  const remaining = rec.modules.filter(m => !rec.completed[m]);
  return { ok:true, expired: !!rec.used, remaining, modules: rec.modules };
}

/* ---------------------------
   Utility: check if module is unlocked for visitor (using visitor-side unlocked records)
   - We also track visitor unlocked modules in localStorage per visitor
   --------------------------- */
const VISITOR_KEY = 'prometric_visitor_unlocked_v1';
function markVisitorUnlocked(moduleName){ 
  const v = JSON.parse(localStorage.getItem(VISITOR_KEY) || '{}');
  v[moduleName] = true; localStorage.setItem(VISITOR_KEY, JSON.stringify(v));
}
function isVisitorUnlocked(moduleName){ const v = JSON.parse(localStorage.getItem(VISITOR_KEY) || '{}'); return !!v[moduleName]; }
function clearVisitorUnlocks(){ localStorage.removeItem(VISITOR_KEY); }

/* ---------------------------
   Integration example:
   Replace your existing lockModule(...) with this function call:
   call `startUnlockFlow(moduleName, redirectUrl)` when user clicks locked module.
   --------------------------- */
async function startUnlockFlow(moduleName, redirectUrl){
  // 1) Ask user to contact WA (payment instructions)
  const confirmMsg = `The "${moduleName}" module is locked.\n\nTo unlock:\n1) Transfer IDR 200k to OVO: +6285399652487\n2) After payment, request unlock via WhatsApp.`;
  alert(confirmMsg);

  // Pre-fill WA message
  const waText = encodeURIComponent(`Hello, I want to unlock "${moduleName}" module. I will transfer IDR 200,000 via OVO to +6285399652487. After payment, please send the unlock code.`);
  window.open(`https://wa.me/6285399652487?text=${waText}`, '_blank');

  // Ask user's WhatsApp number (so admin can verify)
  const userPhone = prompt("Enter your WhatsApp number used to contact us (include +):");
  if(!userPhone) return alert('No WhatsApp number entered.');

  // Ask for code
  const code = prompt("Enter the unlock code you received via WhatsApp after payment:");
  if(!code) return alert('No code entered.');

  // Verify
  const res = await verifyCodeForUser(userPhone, code);
  if(!res.ok) return alert('Invalid code or verification failed. Please contact admin.');

  // If backend mode, server should respond with record and modules
  const record = res.record || res; // in local mode verifyCodeForUser returned {ok:true, record}

  // mark this module completed for the code (this will auto-expire code if all modules completed)
  const mres = markModuleCompleted(code, moduleName);
  if(!mres.ok) return alert('Verification failed: ' + (mres.reason || 'unknown'));

  // mark visitor unlocked for this module (so they can re-open locally)
  markVisitorUnlocked(moduleName);

  // Notify if expired
  if(mres.expired) {
    alert(`✅ Module unlocked and marked completed. All modules included in this code have now been used — the code is now expired.`);
  } else {
    alert(`✅ Module unlocked. Remaining modules to use before code expires: ${mres.remaining.join(', ')}`);
  }

  // redirect user to test
  window.location.href = redirectUrl;
}

/* ---------------------------
   Example usage:
   On your page, for each locked button call:
     onclick="startUnlockFlow('fundamental', 'https://.../fundamental.html')"
   For pediatric (open) use the direct link.
   --------------------------- */
</script>
<!-- ===== END SCRIPT ===== -->
